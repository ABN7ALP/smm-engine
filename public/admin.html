<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <style>
    
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>
      <div>
        <button id="logoutBtn" class="btn btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <!-- STATS -->
    <div class="dashboard" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;">
      <div class="card stat-card">ğŸ“‹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª: <strong id="total-services">0</strong></div>
      <div class="card stat-card">ğŸ“ˆ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒÙ„ÙŠÙ‘Ø©: <strong id="total-orders">0</strong></div>
      <div class="card stat-card">â³ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©: <strong id="pending-orders">0</strong></div>
      <div class="card stat-card">ğŸ’° Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±: <strong id="avg-price">0</strong></div>
    </div>

    <!-- CONTROLS -->
    <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;">
      <button id="refreshBtn" class="btn btn-secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button id="exportServices" class="btn btn-info">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</button>
      <button id="exportOrders" class="btn btn-info">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>

    <!-- Accordion for Services and Orders -->
    <div class="accordion mt-4" id="adminAccordion">

      <!-- Services Section -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingServices">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServices" aria-expanded="true" aria-controls="collapseServices">
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª
          </button>
        </h2>
        <div id="collapseServices" class="accordion-collapse collapse show" aria-labelledby="headingServices" data-bs-parent="#adminAccordion">
          <div class="accordion-body">
            <input id="searchServices" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø®Ø¯Ù…Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙØ¦Ø©...">
            <div class="table-responsive">
              <table id="services-table" class="table table-striped table-hover">
                <thead><tr><th>ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Orders Section -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOrders">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOrders" aria-expanded="false" aria-controls="collapseOrders">
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          </button>
        </h2>
        <div id="collapseOrders" class="accordion-collapse collapse" aria-labelledby="headingOrders" data-bs-parent="#adminAccordion">
          <div class="accordion-body">
            <input id="searchOrders" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨ Ø¨Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø·...">
            <div class="table-responsive">
              <table id="orders-table" class="table table-striped table-hover">
                <thead><tr><th>ID</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
    <!-- End of Accordion -->


    <!-- ADD/EDIT SERVICE FORM -->
    <h2 style="margin-top:25px;">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø®Ø¯Ù…Ø©</h2>
    <form id="serviceForm" class="p-3 border rounded bg-light">
      <div class="row g-3">
        <div class="col-md-6">
          <input name="name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" required>
        </div>
        <div class="col-md-6">
          <input name="category" class="form-control" placeholder="Ø§Ù„ÙØ¦Ø© (Ù…Ø«Ø§Ù„: instagram)" required>
        </div>
        <div class="col-md-12">
          <select name="type" id="typeSelect" class="form-select">
            <option value="quantity">ÙƒÙ…ÙŠØ© (Ù„ÙƒÙ„ 1000)</option>
            <option value="fixed">Ø³Ø¹Ø± Ø«Ø§Ø¨Øª</option>
          </select>
        </div>
        <div id="priceContainer" class="col-md-12">
          <input name="rate" type="number" step="0.01" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ 1000" required>
        </div>
        <div id="qtyContainer" class="col-md-12" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <input name="min" type="number" class="form-control" placeholder="Ø£Ø¯Ù†Ù‰ ÙƒÙ…ÙŠØ©" required>
          <input name="max" type="number" class="form-control" placeholder="Ø£Ù‚ØµÙ‰ ÙƒÙ…ÙŠØ©" required>
        </div>
        <input type="hidden" name="id" id="serviceIdInput">
        <div class="col-12">
          <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
          <button type="button" id="clearFormBtn" class="btn btn-outline-secondary">ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        </div>
      </div>
    </form>
    

    <!-- LOGS (preview latest) -->
    <h2 style="margin-top:25px;">Ø¢Ø®Ø± Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Logs)</h2>
    <div id="logsBox" style="max-height:200px;overflow:auto;border:1px solid var(--border-color);padding:8px;border-radius:6px;background-color:#fff;"></div>

    <div id="alert-box" style="margin-top:12px;"></div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  const token = localStorage.getItem('authToken' );
  if (!token) window.location.href = '/login.html';

  const headers = { 'Content-Type': 'application/json', 'x-auth-token': token };
  const alertBox = document.getElementById('alert-box');

  function show(msg, type='success'){
    alertBox.innerHTML = '<div class="alert '+(type==='success'?'alert-success':'alert-error')+'">'+msg+'</div>';
    setTimeout(()=>alertBox.innerHTML='',3500);
  }

  async function fetchWithAuth(url, options={}) {
    options.headers = {...headers, ...(options.headers||{})};
    const r = await fetch(url, options);
    if (r.status === 401) {
      alert("Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
      localStorage.removeItem('authToken');
      window.location.href = '/login.html';
      return null;
    }
    return r;
  }

  document.getElementById('logoutBtn').onclick = async ()=>{
    await fetchWithAuth('/api/auth/logout', { method:'POST' });
    localStorage.removeItem('authToken'); 
    window.location.href = '/login.html';
  };

  // --------- STATS ----------
  async function loadStats(){
    const r = await fetchWithAuth('/api/stats');
    if (!r) return;
    const s = await r.json();
    document.getElementById('total-services').textContent = s.totalServices;
    document.getElementById('total-orders').textContent = s.totalOrders;
    document.getElementById('pending-orders').textContent = s.pendingOrders;
    document.getElementById('avg-price').textContent = '$' + s.avgPrice;
  }

  // --------- SERVICES ----------
  let allServicesData = []; // Cache for services data
  async function loadServices(){
    const r = await fetchWithAuth('/api/services');
    if (!r) return;
    allServicesData = await r.json();
    renderServices(allServicesData);
  }

  function renderServices(list) {
    const tbody = document.querySelector('#services-table tbody'); tbody.innerHTML='';
    list.forEach(s=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td data-label="ID">${s.id}</td><td data-label="Ø§Ù„Ø§Ø³Ù…">${s.name}</td><td data-label="Ø§Ù„ÙØ¦Ø©">${s.category}</td><td data-label="Ø§Ù„Ù†ÙˆØ¹">${s.type}</td><td data-label="Ø§Ù„Ø³Ø¹Ø±">${s.type==='fixed' ? '$'+(s.price||'') : '$'+(s.rate||'')+' /1k'}</td>
      <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
        <button onclick="editService(${s.id})" class="btn btn-sm btn-primary edit-btn">ØªØ¹Ø¯ÙŠÙ„</button>
        <button onclick="deleteService(${s.id})" class="btn btn-sm btn-danger delete-btn">Ø­Ø°Ù</button>
      </td>`;
      tbody.appendChild(tr);
    });
  }

  // --------- ORDERS ----------
  const statusMap = {
    pending: "â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
    processing: "âš™ï¸ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°",
    completed: "âœ… Ù…ÙƒØªÙ…Ù„",
    rejected: "âŒ Ù…Ø±ÙÙˆØ¶"
  };
  let allOrdersData = []; // Cache for orders data
  async function loadOrders(){
    const r = await fetchWithAuth('/api/orders');
    if (!r) return;
    allOrdersData = await r.json();
    const servicesRes = await fetchWithAuth('/api/services');
    if (!servicesRes) return;
    const services = await servicesRes.json();
    const svcMap = {}; services.forEach(s=>svcMap[s.id]=s);
    renderOrders(allOrdersData, svcMap);
  }

  function renderOrders(list, svcMap) {
    const tbody = document.querySelector('#orders-table tbody'); tbody.innerHTML='';
    list.forEach(o=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td data-label="ID">${o.id}</td>
        <td data-label="Ø§Ù„Ø®Ø¯Ù…Ø©">${svcMap[o.serviceId] ? svcMap[o.serviceId].name : o.serviceId}</td>
        <td data-label="Ø§Ù„Ø±Ø§Ø¨Ø·"><a href="${o.link}" target="_blank" rel="noopener">${o.link.substring(0, 30)}...</a></td>
        <td data-label="ÙƒÙ…ÙŠØ©">${o.quantity||''}</td><td data-label="Ø§Ù„Ø³Ø¹Ø±">$${o.price||''}</td>
        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">${statusMap[o.status]||o.status}</td>
        <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="d-flex flex-wrap gap-1">
          <button onclick="updateOrderStatus(${o.id},'processing')" class="btn btn-sm btn-warning">â³</button>
          <button onclick="updateOrderStatus(${o.id},'completed')" class="btn btn-sm btn-success">âœ…</button>
          <button onclick="updateOrderStatus(${o.id},'rejected')" class="btn btn-sm btn-danger">âŒ</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  async function updateOrderStatus(id, status) {
    if (!confirm(`ØªØ£ÙƒÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "${statusMap[status]}"ØŸ`)) return;
    const res = await fetchWithAuth('/api/orders/' + id, { method:'PUT', body:JSON.stringify({ status }) });
    if (res && res.ok) { show('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨'); reloadAll(); } 
    else show('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«','error');
  }

  // --------- LOGS ----------
  async function loadLogs(){
    const r = await fetchWithAuth('/api/logs');
    if (!r) return;
    const logs = await r.json();
    const box = document.getElementById('logsBox'); 
    box.innerHTML = logs.slice(0,50).map(l=>`<div><small class="text-muted">[${new Date(l.time).toLocaleString()}]</small> <strong>${l.user}</strong> ${l.action} <span class="text-info">${JSON.stringify(l.meta)}</span></div>`).join('');
  }

    // --------- SERVICE FORM ----------
    const form = document.getElementById('serviceForm');
    const typeSelect = document.getElementById('typeSelect');

    typeSelect.addEventListener('change', ()=> {
      if (typeSelect.value === 'fixed') {
        document.getElementById('priceContainer').innerHTML = '<input name="price" type="number" step="0.01" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" required>';
        document.getElementById('qtyContainer').style.display='none';
        document.querySelector('[name=min]')?.removeAttribute('required');
        document.querySelector('[name=max]')?.removeAttribute('required');
      } else {
        document.getElementById('priceContainer').innerHTML = '<input name="rate" type="number" step="0.01" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ 1000" required>';
        document.getElementById('qtyContainer').style.display='grid';
        document.querySelector('[name=min]')?.setAttribute('required', 'required');
        document.querySelector('[name=max]')?.setAttribute('required', 'required');
      }
    });

    document.getElementById('clearFormBtn').addEventListener('click', ()=>{
      form.reset(); 
      document.getElementById('serviceIdInput').value='';
      typeSelect.dispatchEvent(new Event('change'));
    });

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      const id = data.id;
      // Clean up data based on type
      if (data.type === 'fixed') {
        delete data.rate; delete data.min; delete data.max;
      } else {
        delete data.price;
      }

      if (id) {
        delete data.id;
        const res = await fetchWithAuth('/api/services/' + id, { method:'PUT', body:JSON.stringify(data) });
        if (res && res.ok) { show('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©'); form.reset(); document.getElementById('serviceIdInput').value=''; reloadAll(); }
        else show('âŒ ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©','error');
      } else {
        const res = await fetchWithAuth('/api/services', { method:'POST', body:JSON.stringify(data) });
        if (res && res.ok) { show('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©'); form.reset(); reloadAll(); }
        else show('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©','error');
      }
    });

    // --------- EDIT / DELETE SERVICE ----------
    window.editService = async function(id){
      const s = allServicesData.find(x=>x.id===id);
      if (!s) return;
      document.querySelector('[name=name]').value = s.name || '';
      document.querySelector('[name=category]').value = s.category || '';
      document.getElementById('serviceIdInput').value = s.id;
      typeSelect.value = s.type;
      typeSelect.dispatchEvent(new Event('change')); // Trigger change to show/hide fields
      if (s.type==='fixed') {
        document.querySelector('[name=price]').value = s.price || '';
      } else {
        document.querySelector('[name=rate]').value = s.rate || '';
        document.querySelector('[name=min]').value = s.min || '';
        document.querySelector('[name=max]').value = s.max || '';
      }
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    };

    window.deleteService = async function(id){
      if (!confirm('âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.')) return;
      const res = await fetchWithAuth('/api/services/' + id, { method:'DELETE' });
      if (res && res.ok) { show('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©'); reloadAll(); }
      else show('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©','error');
    };

    // --------- SEARCH FUNCTIONALITY ----------
    document.getElementById('searchServices').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = allServicesData.filter(s => 
        s.name.toLowerCase().includes(query) || 
        s.category.toLowerCase().includes(query)
      );
      renderServices(filtered);
    });

    document.getElementById('searchOrders').addEventListener('input', async (e) => {
      const query = e.target.value.toLowerCase();
      const servicesRes = await fetchWithAuth('/api/services');
      if (!servicesRes) return;
      const services = await servicesRes.json();
      const svcMap = {}; services.forEach(s=>svcMap[s.id]=s);
      const filtered = allOrdersData.filter(o => 
        String(o.id).includes(query) || 
        o.link.toLowerCase().includes(query) ||
        (svcMap[o.serviceId] && svcMap[o.serviceId].name.toLowerCase().includes(query))
      );
      renderOrders(filtered, svcMap);
    });


    document.getElementById('refreshBtn').onclick = async ()=> {
      await reloadAll();
      show('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    };

  // --------- RELOAD ----------
  async function reloadAll(){ 
    await Promise.all([loadStats(), loadServices(), loadOrders(), loadLogs()]); 
  }


    // --------- EXPORT CSV WITH AUTH ----------
    async function downloadCSV(endpoint, filename) {
      const r = await fetchWithAuth(endpoint);
      if (!r || !r.ok) { show('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù','error'); return; }
      const text = await r.text();
      const blob = new Blob(["\uFEFF" + text], { type: "text/csv;charset=utf-8;" });

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    }
    
    document.getElementById('exportServices').onclick = ()=> {
      downloadCSV('/api/export/services.csv','Ø§Ù„Ø®Ø¯Ù…Ø§Øª.csv');
    };
    document.getElementById('exportOrders').onclick = ()=> {
      downloadCSV('/api/export/orders.csv','Ø§Ù„Ø·Ù„Ø¨Ø§Øª.csv');
    };

  reloadAll();
  </script>

</body>
</html>
