<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>

    <!-- AdminKit CSS - Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <link href="https://cdn.jsdelivr.net/npm/adminkit-pro@4.0.0/dist/css/app.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Cairo Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles - Ù„Ù…Ø³Ø§ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© -->
    <style>
        body, .sidebar-brand, .sidebar-link, .btn, .form-control, .card-title, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: 'Cairo', sans-serif;
        }
        /* Fix for RTL layout with AdminKit sidebar */
        .sidebar {
            direction: ltr; 
        }
        .sidebar-content {
            direction: rtl;
        }
        .main {
            margin-right: 260px;
            margin-left: 0;
        }
        .stat-card .stat-icon {
            font-size: 2.5rem;
        }
        .table-actions .btn {
            margin: 0 2px;
        }
        /* Mobile fixes */
        @media (max-width: 767.98px) {
            .main {
                margin-right: 0;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- 1. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) -->
        <nav id="sidebar" class="sidebar js-sidebar">
            <div class="sidebar-content js-simplebar">
                <a class="sidebar-brand" href="#">
                    <i class="align-middle" data-feather="box"></i>
                    <span class="align-middle">Ø§Ù„Ù…Ø±Ø´Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ</span>
                </a>

                <ul class="sidebar-nav">
                    <li class="sidebar-header">
                        Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </li>

                    <li class="sidebar-item active" data-page="dashboard">
                        <a class="sidebar-link" href="#">
                            <i class="align-middle" data-feather="sliders"></i> <span class="align-middle">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span>
                        </a>
                    </li>

                    <li class="sidebar-item" data-page="services">
                        <a class="sidebar-link" href="#">
                            <i class="align-middle" data-feather="grid"></i> <span class="align-middle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span>
                        </a>
                    </li>

                    <li class="sidebar-item" data-page="orders">
                        <a class="sidebar-link" href="#">
                            <i class="align-middle" data-feather="shopping-cart"></i> <span class="align-middle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                        </a>
                    </li>
                    
                    <li class="sidebar-item" data-page="logs">
                        <a class="sidebar-link" href="#">
                            <i class="align-middle" data-feather="activity"></i> <span class="align-middle">Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- 2. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Content) -->
        <div class="main">
            <!-- 2.1. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Navbar) -->
            <nav class="navbar navbar-expand navbar-light navbar-bg">
                <a class="sidebar-toggle js-sidebar-toggle">
                    <i class="hamburger align-self-center"></i>
                </a>
                <div class="navbar-collapse collapse">
                    <ul class="navbar-nav navbar-align">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
                                <span class="text-dark">Admin</span>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end">
                                <a class="dropdown-item" id="logoutBtn" href="#"><i class="align-middle me-1" data-feather="log-out"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 2.2. Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª -->
            <main class="content">
                <div class="container-fluid p-0">

                    <!-- ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª (Dashboard) -->
                    <div id="dashboard-page" class="page">
                        <h1 class="h3 mb-3"><strong>Ù„ÙˆØ­Ø©</strong> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h1>
                        <div class="row">
                            <div class="col-sm-6 col-xl-3">
                                <div class="card"><div class="card-body"><div class="row"><div class="col mt-0"><h5 class="card-title">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h5></div><div class="col-auto"><div class="stat text-primary"><i class="align-middle" data-feather="grid"></i></div></div></div><h1 id="total-services" class="mt-1 mb-3">0</h1></div></div>
                            </div>
                            <div class="col-sm-6 col-xl-3">
                                <div class="card"><div class="card-body"><div class="row"><div class="col mt-0"><h5 class="card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h5></div><div class="col-auto"><div class="stat text-primary"><i class="align-middle" data-feather="shopping-cart"></i></div></div></div><h1 id="total-orders" class="mt-1 mb-3">0</h1></div></div>
                            </div>
                            <div class="col-sm-6 col-xl-3">
                                <div class="card"><div class="card-body"><div class="row"><div class="col mt-0"><h5 class="card-title">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</h5></div><div class="col-auto"><div class="stat text-primary"><i class="align-middle" data-feather="loader"></i></div></div></div><h1 id="pending-orders" class="mt-1 mb-3">0</h1></div></div>
                            </div>
                            <div class="col-sm-6 col-xl-3">
                                <div class="card"><div class="card-body"><div class="row"><div class="col mt-0"><h5 class="card-title">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±</h5></div><div class="col-auto"><div class="stat text-primary"><i class="align-middle" data-feather="dollar-sign"></i></div></div></div><h1 id="avg-price" class="mt-1 mb-3">$0.00</h1></div></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h5 class="card-title mb-0">Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª (Ø¢Ø®Ø± 10)</h5></div>
                            <div class="card-body" id="logsBox" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª -->
                    <div id="services-page" class="page" style="display:none;">
                        <h1 class="h3 mb-3"><strong>Ø¥Ø¯Ø§Ø±Ø©</strong> Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h1>
                        <div class="row">
                            <div class="col-12 col-lg-8">
                                <div class="card">
                                    <div class="card-header"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h5></div>
                                    <div class="card-body">
                                        <input id="searchServices" class="form-control mb-3" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙØ¦Ø©...">
                                        <div class="table-responsive">
                                            <table id="services-table" class="table table-striped table-hover">
                                                <thead><tr><th>ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4">
                                <div class="card">
                                    <div class="card-header"><h5 class="card-title" id="form-title">Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5></div>
                                    <div class="card-body">
                                        <form id="serviceForm">
                                            <input type="hidden" name="id" id="serviceIdInput">
                                            <div class="mb-3"><input name="name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©" required></div>
                                            <div class="mb-3"><input name="category" class="form-control" placeholder="Ø§Ù„ÙØ¦Ø© (Ù…Ø«Ø§Ù„: instagram)" required></div>
                                            <div class="mb-3">
                                                <select name="type" id="typeSelect" class="form-select">
                                                    <option value="quantity">ÙƒÙ…ÙŠØ© (Ù„ÙƒÙ„ 1000)</option>
                                                    <option value="fixed">Ø³Ø¹Ø± Ø«Ø§Ø¨Øª</option>
                                                </select>
                                            </div>
                                            <div id="priceContainer" class="mb-3">
                                                <input name="rate" type="number" step="0.01" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ 1000" required>
                                            </div>
                                            <div id="qtyContainer" class="row g-2 mb-3">
                                                <div class="col"><input name="min" type="number" class="form-control" placeholder="Ø£Ø¯Ù†Ù‰ ÙƒÙ…ÙŠØ©" required></div>
                                                <div class="col"><input name="max" type="number" class="form-control" placeholder="Ø£Ù‚ØµÙ‰ ÙƒÙ…ÙŠØ©" required></div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                                                <button type="button" id="clearFormBtn" class="btn btn-outline-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
                    <div id="orders-page" class="page" style="display:none;">
                        <h1 class="h3 mb-3"><strong>Ø¥Ø¯Ø§Ø±Ø©</strong> Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
                        <div class="card">
                            <div class="card-header"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h5></div>
                            <div class="card-body">
                                <input id="searchOrders" class="form-control mb-3" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø·...">
                                <div class="table-responsive">
                                    <table id="orders-table" class="table table-striped table-hover">
                                        <thead><tr><th>ID</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø±Ø§Ø¨Ø·</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ØµÙØ­Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„ -->
                    <div id="logs-page" class="page" style="display:none;">
                        <h1 class="h3 mb-3"><strong>Ø³Ø¬Ù„</strong> Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„</h1>
                        <div class="card">
                            <div class="card-body" id="fullLogsBox"></div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- AdminKit JS -->
    <script src="https://cdn.jsdelivr.net/npm/adminkit-pro@4.0.0/dist/js/app.js"></script>

    <!-- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ù…ÙØ¹Ø§Ø¯ Ù‡ÙŠÙƒÙ„ØªÙ‡) -->
    <script>
        // =================================================================
// Admin Dashboard Logic - v2.0 (Powered by AdminKit)
// =================================================================

document.addEventListener("DOMContentLoaded", () => {
    // --- 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication) ---
    const token = localStorage.getItem('authToken');
    if (!token) {
        window.location.href = '/login.html';
        return;
    }
    const headers = { 'Content-Type': 'application/json', 'x-auth-token': token };

    // --- 2. ØªØ¹Ø±ÙŠÙ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ Ø³Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ ---
    const pageElements = {
        dashboard: document.getElementById('dashboard-page'),
        services: document.getElementById('services-page'),
        orders: document.getElementById('orders-page'),
        logs: document.getElementById('logs-page'),
    };
    const serviceForm = document.getElementById('serviceForm');
    const formTitle = document.getElementById('form-title');
    let allServicesData = [];
    let allOrdersData = [];
    let servicesMap = {};

    // --- 3. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers) ---
    async function fetchWithAuth(url, options = {}) {
        options.headers = { ...headers, ...(options.headers || {}) };
        try {
            const response = await fetch(url, options);
            if (response.status === 401) {
                alert("Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
                return null;
            }
            if (!response.ok) throw new Error(`ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨: ${response.statusText}`);
            return response;
        } catch (error) {
            console.error('Fetch Error:', error);
            return null;
        }
    }
    
    function formatDateTime(isoString) {
        return new Date(isoString).toLocaleString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    // --- 4. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª (Page Navigation) ---
    document.querySelectorAll('.sidebar-item[data-page]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const page = item.getAttribute('data-page');
            
            Object.values(pageElements).forEach(el => el.style.display = 'none');
            pageElements[page].style.display = 'block';

            document.querySelectorAll('.sidebar-item[data-page]').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
        });
    });

    // --- 5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ (Render Functions) ---
    function renderStats(stats) {
        document.getElementById('total-services').textContent = stats.totalServices || 0;
        document.getElementById('total-orders').textContent = stats.totalOrders || 0;
        document.getElementById('pending-orders').textContent = stats.pendingOrders || 0;
        document.getElementById('avg-price').textContent = `$${(stats.avgPrice || 0).toFixed(2)}`;
    }

    function renderServices(list) {
        const tbody = document.getElementById('services-table').querySelector('tbody');
        tbody.innerHTML = list.map(s => `
            <tr>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td><span class="badge bg-info">${s.category}</span></td>
                <td>${s.type}</td>
                <td>${s.type === 'fixed' ? `$${s.price || ''}` : `$${s.rate || ''} /1k`}</td>
                <td class="table-actions">
                    <button onclick="window.editService(${s.id})" class="btn btn-sm btn-primary"><i data-feather="edit-2"></i></button>
                    <button onclick="window.deleteService(${s.id})" class="btn btn-sm btn-danger"><i data-feather="trash"></i></button>
                </td>
            </tr>
        `).join('');
        feather.replace();
    }

    function renderOrders(list) {
        const statusMap = {
            pending: { label: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", class: "warning" },
            processing: { label: "Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°", class: "primary" },
            completed: { label: "Ù…ÙƒØªÙ…Ù„", class: "success" },
            rejected: { label: "Ù…Ø±ÙÙˆØ¶", class: "danger" }
        };
        const tbody = document.getElementById('orders-table').querySelector('tbody');
        tbody.innerHTML = list.map(o => {
            const statusInfo = statusMap[o.status] || { label: o.status, class: "secondary" };
            return `
                <tr>
                    <td>${o.id}</td>
                    <td>${servicesMap[o.serviceId]?.name || `Ø®Ø¯Ù…Ø© #${o.serviceId}`}</td>
                    <td><a href="${o.link}" target="_blank" rel="noopener">${o.link.substring(0, 35)}...</a></td>
                    <td>${o.quantity || 'N/A'}</td>
                    <td>$${(o.price || 0).toFixed(2)}</td>
                    <td><span class="badge bg-${statusInfo.class}">${statusInfo.label}</span></td>
                    <td class="table-actions">
                        <div class="btn-group"><button class="btn btn-sm btn-outline-primary" onclick="window.updateOrderStatus(${o.id},'processing')">âš™ï¸</button><button class="btn btn-sm btn-outline-success" onclick="window.updateOrderStatus(${o.id},'completed')">âœ…</button><button class="btn btn-sm btn-outline-danger" onclick="window.updateOrderStatus(${o.id},'rejected')">âŒ</button></div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function renderLogs(logs, containerId) {
        const actionMap = {
            order_create: { icon: "shopping-cart", color: "success" }, order_update: { icon: "edit", color: "info" },
            service_create: { icon: "plus-circle", color: "primary" }, service_update: { icon: "edit-2", color: "warning" },
            service_delete: { icon: "trash-2", color: "danger" }, login: { icon: "log-in", color: "secondary" },
            logout: { icon: "log-out", color: "secondary" }
        };
        const box = document.getElementById(containerId);
        box.innerHTML = logs.map(l => {
            const actionInfo = actionMap[l.action] || { icon: 'activity', color: 'dark' };
            return `<div class="d-flex align-items-start mb-2"><div class="me-3"><span class="badge bg-${actionInfo.color}"><i data-feather="${actionInfo.icon}"></i></span></div><div class="flex-grow-1"><strong>${l.user}</strong> ${l.action.replace('_', ' ')}<div class="text-muted small mt-1">${formatDateTime(l.time)}</div></div></div>`;
        }).join('');
        feather.replace();
    }

    // --- 6. Ø¯ÙˆØ§Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Data Loading) ---
    async function loadAllData() {
        const [statsRes, servicesRes, ordersRes, logsRes] = await Promise.all([
            fetchWithAuth('/api/stats'), fetchWithAuth('/api/services'),
            fetchWithAuth('/api/orders'), fetchWithAuth('/api/logs')
        ]);
        if (statsRes) renderStats(await statsRes.json());
        if (servicesRes) {
            allServicesData = await servicesRes.json();
            servicesMap = allServicesData.reduce((map, s) => (map[s.id] = s, map), {});
            renderServices(allServicesData);
        }
        if (ordersRes) {
            allOrdersData = await ordersRes.json();
            renderOrders(allOrdersData);
        }
        if (logsRes) {
            const logs = await logsRes.json();
            renderLogs(logs.slice(0, 10), 'logsBox');
            renderLogs(logs, 'fullLogsBox');
        }
    }

    // --- 7. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Service Management) ---
    const typeSelect = document.getElementById('typeSelect');
    typeSelect.addEventListener('change', () => {
        const isFixed = typeSelect.value === 'fixed';
        document.getElementById('priceContainer').innerHTML = isFixed ? '<input name="price" type="number" step="0.01" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" required>' : '<input name="rate" type="number" step="0.01" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ 1000" required>';
        document.getElementById('qtyContainer').style.display = isFixed ? 'none' : 'flex';
        document.querySelector('[name=min]').required = !isFixed;
        document.querySelector('[name=max]').required = !isFixed;
    });

    document.getElementById('clearFormBtn').addEventListener('click', () => {
        serviceForm.reset();
        document.getElementById('serviceIdInput').value = '';
        formTitle.textContent = 'Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        typeSelect.dispatchEvent(new Event('change'));
    });

    serviceForm.addEventListener('submit', async e => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(serviceForm).entries());
        const id = data.id;
        if (data.type === 'fixed') { delete data.rate; delete data.min; delete data.max; } else { delete data.price; }
        const url = id ? `/api/services/${id}` : '/api/services';
        const method = id ? 'PUT' : 'POST';
        const res = await fetchWithAuth(url, { method, body: JSON.stringify(data) });
        if (res) {
            alert(`âœ… ØªÙ… ${id ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­`);
            document.getElementById('clearFormBtn').click();
            loadAllData();
        } else {
            alert(`âŒ ÙØ´Ù„ ÙÙŠ ${id ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ©'} Ø§Ù„Ø®Ø¯Ù…Ø©`);
        }
    });

    window.editService = (id) => {
        const s = allServicesData.find(x => x.id === id);
        if (!s) return;
        formTitle.textContent = `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© #${id}`;
        serviceForm.querySelector('[name=id]').value = s.id;
        serviceForm.querySelector('[name=name]').value = s.name || '';
        serviceForm.querySelector('[name=category]').value = s.category || '';
        typeSelect.value = s.type;
        typeSelect.dispatchEvent(new Event('change'));
        if (s.type === 'fixed') { serviceForm.querySelector('[name=price]').value = s.price || ''; } 
        else {
            serviceForm.querySelector('[name=rate]').value = s.rate || '';
            serviceForm.querySelector('[name=min]').value = s.min || '';
            serviceForm.querySelector('[name=max]').value = s.max || '';
        }
        serviceForm.querySelector('[name=name]').focus();
    };

    window.deleteService = async (id) => {
        if (!confirm('âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.')) return;
        const res = await fetchWithAuth(`/api/services/${id}`, { method: 'DELETE' });
        if (res) { alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©'); loadAllData(); } else { alert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©'); }
    };

    // --- 8. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Order Management) ---
    window.updateOrderStatus = async (id, status) => {
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "${status}"ØŸ`)) return;
        const res = await fetchWithAuth(`/api/orders/${id}`, { method: 'PUT', body: JSON.stringify({ status }) });
        if (res) { alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨'); loadAllData(); } else { alert('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«'); }
    };

    // --- 9. Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµØ¯ÙŠØ± (Search & Export) ---
    document.getElementById('searchServices').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        renderServices(allServicesData.filter(s => s.name.toLowerCase().includes(query) || s.category.toLowerCase().includes(query)));
    });
    document.getElementById('searchOrders').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        renderOrders(allOrdersData.filter(o => String(o.id).includes(query) || o.link.toLowerCase().includes(query) || (servicesMap[o.serviceId]?.name.toLowerCase().includes(query))));
    });

    // --- 10. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ---
    document.getElementById('logoutBtn').onclick = async () => {
        await fetchWithAuth('/api/auth/logout', { method: 'POST' });
        localStorage.removeItem('authToken');
        window.location.href = '/login.html';
    };

    loadAllData();
});
</script>
  
    
</body>
</html>
